#!/usr/bin/python2.7
#r = requests.get(config.url + "false")
#r = requests.get(config.url + "true " + str(counter))
import requests
import time
from pytz import timezone
from datetime import datetime, timedelta
from hosted import device, node, config

counter = 0
eastern = timezone('US/Eastern')
device.gpio.monitor(config.pin)
for (pin, state) in device.gpio.poll_forever():
    while 1:
        counter += 1
        node.send('/counter:%d' % counter)
        url = config.db
        headers = {
            'Content-Type': 'application/json',
            "x-apikey": config.api
        }
        data = {
            "device_id": config.metadata['device_id'],
            "day": datetime.now(eastern).strftime("%m/%d/%Y"),
            "hour": datetime.now(eastern).strftime('%H:%M:%S'),
            "motion": counter,
        }
        req = requests.post(url, json=data, headers=headers)
        r = requests.get(config.url + str(req) + str(counter) + str(datetime.now(eastern).strftime('%H:%M:%S')) + str(datetime.now(eastern).strftime("%m/%d/%Y")))
